name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  compile:
    name: Compile Examples
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: composable-nfts
            path: snippets/composable-nfts
          - name: controlled-mint
            path: snippets/controlled-mint
          - name: data-structures-heap
            path: snippets/data-structures/heap
          - name: autonomous-objects
            path: snippets/design-patterns/autonomous-objects
          - name: error-codes
            path: snippets/error-codes
          - name: fa-lockup-example
            path: snippets/fa-lockup-example
          - name: fractional-token
            path: snippets/fractional-token
            # Uses --named-addresses instead of --dev due to broken TokenMinter dev-dependency
            compile_flags: "--named-addresses fraction_addr=0x1337,minter=0x2337"
          - name: liquid-nfts
            path: snippets/liquid-nfts
          - name: lootbox
            path: snippets/lootbox
          - name: modifying-nfts
            path: snippets/modifying-nfts
          - name: objects
            path: snippets/objects
          - name: parallel-nfts
            path: snippets/parallel-nfts
          - name: private-vs-public-dice-roll
            path: snippets/private-vs-public/dice_roll
          - name: private-vs-public-cheater
            path: snippets/private-vs-public/cheater
          - name: prover
            path: snippets/prover
          - name: storage
            path: snippets/storage
          - name: struct-capabilities
            path: snippets/struct-capabilities

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Aptos CLI
        run: |
          curl -fsSL "https://aptos.dev/scripts/install_cli.py" | python3
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Compile ${{ matrix.name }}
        working-directory: ${{ matrix.path }}
        run: aptos move compile ${{ matrix.compile_flags || '--dev' }}

  test:
    name: Test Examples
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: data-structures-heap
            path: snippets/data-structures/heap
          - name: error-codes
            path: snippets/error-codes
          - name: fa-lockup-example
            path: snippets/fa-lockup-example
          - name: controlled-mint
            path: snippets/controlled-mint

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Aptos CLI
        run: |
          curl -fsSL "https://aptos.dev/scripts/install_cli.py" | python3
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Test ${{ matrix.name }}
        working-directory: ${{ matrix.path }}
        run: aptos move test --dev
